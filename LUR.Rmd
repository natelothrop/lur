---
title: "Lothrop PhD - Aim 1"
author: "Nathan Lothrop"
date: "January 20, 2019"
output: html_document
---


## General LUR Workflow

In order to create the best externally validated LUR model for each pollutant, there are several steps: 

1. wrangling the source data for TAPS and PCWS, as well as PDEQ background monitor data; 
2. developing the LUR model using the ESCAPE method; and 
3. externally validating the model with 4 different ways of adjusting for changes over time.

### Wrangling Study Data

Basic steps:

1. Pull in study data
2. pull in background PDEQ monitor
3. create annual avg of each pollutant via ESCAPE method

However PCWS didn't follow ESCAPE so this is slightly more involved and we will have to make assumptions compared to TAPS.

```{r Data Setup, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# Clear environment of temporary files
rm(list=ls())

# Read in packages
packages <- c('Hmisc', 'corrplot', 'tidyverse', 'ggplot2')

package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})

#read in all p5 data
p5all<- read.csv("/Users/nathanlothrop/Dropbox/P5_TAPS_TEMP/P5/Data/LUR/Results/P5_Master.csv")

#subset out the monitor data that has hhid >5000
monitor<-subset(p5all,hhid>5001)
data<-subset(p5all,hhid<5001)

str(data)

keeps<-c("hhid","stday","stmon","styear",
         "endday","endmon","endyear"
         ,"no2ppb", "pm25ugm3","pm10ugm3")
data<-data[keeps]

# Average duplicates (same run period)
data <- data %>%
  group_by(hhid,stday,stmon,styear,endday,endmon,endyear) %>%
  summarise(no2ppb = mean(no2ppb),
         pm25ugm3 = mean(pm25ugm3),
         pm10ugm3 = mean(pm10ugm3))


# Assign 1 of 3 season values (Winter, Intermed, Summer)
data$stssn3 <- ifelse((data$stmon==3 | data$stmon==4 | data$stmon==9 | data$stmon==10), 2,
                     ifelse((data$stmon==1 | data$stmon==2 | data$stmon==11 | data$stmon==12), 1, 3))
                               
data$stssn3 <- factor(data$stssn3,
                    levels = c(1,2,3),
                    labels = c("Winter", "Intermed.", "Summer"))

# Assign 1 of 4 season values (Winter, Spring, Summer, Fall)
data$stssn4 <- ifelse((data$stmon==1 | data$stmon==2 | data$stmon==11 | data$stmon==12), 1,
                      ifelse((data$stmon==3 | data$stmon==4), 2,
                              ifelse((data$stmon==5 | data$stmon==6 | data$stmon==7 | data$stmon==8), 3, 4)))
                               
data$stssn4 <- factor(data$stssn4,
                    levels = c(1,2,3,4),
                    labels = c("Winter", "Spring", "Summer", "Fall"))

datano2 <- subset(data,!is.na(no2ppb))
datapm25 <- subset(data,!is.na(pm25ugm3))
datapm10 <- subset(data,!is.na(pm10ugm3))


```

######PCWS NO2
```{r, echo=FALSE, warning=FALSE}
data %>%
  filter(!is.na(no2ppb)) %>%
  group_by(styear) %>%
  summarise(n.obs=length(no2ppb),
            n.homes=n_distinct(hhid),
            geomean=exp(mean(log(no2ppb))),
            mean=mean(no2ppb),
            geosd=exp(sd(log(no2ppb))),
            min=min(no2ppb),
            max=max(no2ppb))
```

######PCWS PM2.5
```{r, echo=FALSE, warning=FALSE}
data %>%
  filter(!is.na(pm25ugm3)) %>%
  group_by(styear) %>%
  summarise(n.obs=length(pm25ugm3),
            n.homes=n_distinct(hhid),
            geomean=exp(mean(log(pm25ugm3))),
            mean=mean(pm25ugm3),
            geosd=exp(sd(log(pm25ugm3))),
            min=min(pm25ugm3),
            max=max(pm25ugm3))
```

######PCWS PM10
```{r, echo=FALSE, warning=FALSE}
data %>%
  filter(!is.na(pm10ugm3)) %>%
  group_by(styear) %>%
  summarise(n.obs=length(pm10ugm3),
            n.homes=n_distinct(hhid),
            geomean=exp(mean(log(pm10ugm3))),
            mean=mean(pm10ugm3),
            geosd=exp(sd(log(pm10ugm3))),
            min=min(pm10ugm3),
            max=max(pm10ugm3))
```
Many PCWS homes are measured more than once in a year, but often are measured back to back (one week, then the next). We will use all measures (and correct for changes in air pollution levels over time), as ESCAPE allows for 1-3 or more measures throughout the year (see page 9 and 10 here: http://escapeproject.eu/manuals/ESCAPE_Exposure-manualv9.pdf).

However, before committing to this, we will investigate how many homes have measures over multiple years, because if they do, then it may not make sense in LUR development if we have predictors that change over the time span to put all homes in the same model.


######Homes with more than 2 measures in different MONTHS in the same year for NO2:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

# data %>%
#   filter(!is.na(no2ppb)) %>%
#   dplyr::group_by(hhid,styear, stmon) %>%
#   summarise(n_homes = n_distinct(hhid),
#             n_obs_no2 = n_distinct(no2ppb)) %>%
#   arrange(desc(n_obs_no2, hhid))
            
datano2 <- datano2 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(no2_bymonth = n_distinct(stmon))

datano2 %>%
  filter(no2_bymonth>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(no2ppb))
```
So for NO2, there are multiple homes in 87-89 with 2 or more measures in the same month and different months in the same year.



Let's check this same thing for PM2.5.

######Homes with 2 or more measures in different MONTHS in the same year for PM2.5:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm25 <- datapm25 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm25_bymonth = n_distinct(stmon))

datapm25 %>%
  filter(pm25_bymonth>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm25ugm3))
```
For PM2.5, only 2 homes have more than 1 measure in different months. 

######Homes with 2 or more measures in different MONTHS in the same year for PM10:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm10 <- datapm10 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm10_bymonth = n_distinct(stmon))

datapm10 %>%
  filter(pm10_bymonth>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm10ugm3))
```
For PM10, only 2 homes have more than 1 measure in different months. 


######Homes with 2 or more measures in different SEASONS in the same year (ESCAPE 3-season approach) for NO2:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datano2 <- datano2 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(no2_byseason3 = n_distinct(stssn3))

datano2 %>%
  filter(no2_byseason3>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(no2ppb))
``` 

######Homes with 2 or more measures in different SEASONS in the same year (ESCAPE 3-season approach) for PM2.5:
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# 
# data %>%
#   filter(!is.na(no2ppb)) %>%
#   dplyr::group_by(hhid,styear, stssn3) %>%
#   summarise(n_homes = n_distinct(hhid),
#             n_obs_no2 = n_distinct(no2ppb)) %>%
#   arrange(desc(n_obs_no2, hhid))

datapm25 <- datapm25 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm25_byseason3 = n_distinct(stssn3))

datapm25 %>%
  filter(pm25_byseason3>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm25ugm3))
``` 
There are NO homes with 2 or more PM2.5 measures in different ESCAPE seasons in same year.

######Homes with 2 or more measures in different SEASONS in the same year (ESCAPE 3-season approach) for PM10:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm10 <- datapm10 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm10_byseason3 = n_distinct(stssn3))

datapm10 %>%
  filter(pm10_byseason3>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm10ugm3))
``` 
There are NO homes with 2 or more PM10 measures in different ESCAPE seasons in same year.

######Homes with 2 or more measures in different SEASONS in the same year (non-ESCAPE 4-season approach) for NO2:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datano2 <- datano2 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(no2_byseason4 = n_distinct(stssn4))

datano2 %>%
  filter(no2_byseason4>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(no2ppb))
``` 
######Homes with 2 or more measures in different SEASONS in the same year (non-ESCAPE 4-season approach) for PM2.5:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm25 <- datapm25 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm25_byseason4 = n_distinct(stssn4))

datapm25 %>%
  filter(pm25_byseason4>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm25ugm3))
```
No homes again for PM2.5, using 4 season approach.

######Homes with 2 or more measures in different SEASONS in the same year (non-ESCAPE 4-season approach) for PM10:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm10 <- datapm10 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm10_byseason4 = n_distinct(stssn4))

datapm10 %>%
  filter(pm10_byseason4>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm10ugm3))
```
No homes again for PM10, using 4 season approach.

Let's now look at what homes have a measure in different years...

Now let's look at whether there are homes that have >=1 NO2 measure IN multiple years.

######Homes with 1 or more measures in different MONTHS in the same year over MULTIPLE years for NO2:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

#create frequency of measurement by year and season
#no2
datano2 <- datano2 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(no2_bymonth = n_distinct(stmon))

datano2 %>%
  group_by(hhid,styear) %>%
  summarise(n_obs_no2 = n_distinct(no2ppb)) %>%
  filter(n_obs_no2>1) %>%
  arrange(hhid,desc(n_obs_no2))
```

There are many homes that have obs in more than 1 year (>1 distinct measure/month).

######Homes with 2 or more measures in different SEASONS in the same year over MULTIPLE years for NO2:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

#create frequency of measurement by year and season
#no2
datano2 <- datano2 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(no2_byseason3 = n_distinct(stssn3))

datano2 %>%
  filter(no2_byseason3>1) %>%
  group_by(hhid) %>%
  summarise(n_years = n_distinct(styear),
            n_obs = n_distinct(no2ppb)) %>%
  arrange(desc(n_years,hhid))
```
**NO2**Homes that have NO2 measures >=1/year are done OVER multiple years. However those with >1 NO2 measure/year do NOT have measures in multiple years.

**PM**Homes that have PM measures >=1/year are done OVER multiple years. However those with >1 PM measure/year only have "next week" measures in that year and then some have 1 measure in another year, however there are essentially none of these.

**This means that if we stuck to "more than 1 measure in a year" approach, we'd be able to do have yearly-based predictors with homes that only have an annual avg outcome in one year for NO2 alone! There are no homes that did PM that would be included in this approach.**

**This means that we could 1) use different inclusion criteria to make this work (NO2: >1 measure/year with no repeat measures in a month, in multiple months; PM: >=1 measure/year, in multiple months). THis makes no sense!**

**FOR NOW, we will use following approach**

1. do annual average for homes with >=1 measure in 1987, then 1988...1992
2. figure out what homes have multiple annual averages (ie have a measure in >=1year)
3. compare averages among these homes that have multiple annual avgs

#### PCWS Annual Averages

##### Create Daily Avg for PDEQ Background Monitors
```{r, echo=FALSE, message=FALSE, warning=FALSE}

# Read in NO2, PM2.5, and PM10 background values from the longest, constantly running PDEQ monitors for NAAQS compliance
# Downloaded in 20 year increments for all available data from 1980 - 2017 from https://aqs.epa.gov/api on 2018/12/28 with user: lothrop@email.arizona.edu and password 'rubycat56'
# NO2, PM2.5, and PM10 monitor sites that running longest aren't same (NO2: Alvernon/Craycroft; PM2.5: Saguaro Park; PM10: Orange Grove)
# Note that PM2.5 monitoring is taken offline temporarily at Saguaro Park 1994-1999

wd <- "/Users/nathanlothrop/Dropbox/P5_TAPS_TEMP/Data/PDEQHistoric"

no2_ref <- read.csv(paste0(wd,"/","NO2_1980_2000.txt"), header = T)

pm25_ref <- read.csv(paste0(wd,"/","PM25_1980_2000.txt"), header = T)

pm10_ref <- read.csv(paste0(wd,"/","PM10_1980_2000.txt"), header = T)

# Create annual averages for each pollutant type
no2_ref <- no2_ref %>%
  dplyr::group_by(Date.Local) %>%
  dplyr::summarise(no2_ref = mean(Sample.Measurement)) %>%
  dplyr::filter(!is.na(Date.Local) | !is.na(no2_ref)) %>%
  dplyr::select(Date.Local, no2_ref)

pm25_ref <- pm25_ref %>%
  dplyr::group_by(Date.Local) %>%
  dplyr::summarise(pm25_ref = mean(Sample.Measurement)) %>%
  dplyr::filter(!is.na(Date.Local) | !is.na(pm25_ref)) %>%
  dplyr::select(Date.Local, pm25_ref)
  
pm10_ref <- pm10_ref %>%
  dplyr::group_by(Date.Local) %>%
  dplyr::summarise(pm10_ref = mean(Sample.Measurement)) %>%
  dplyr::filter(!is.na(Date.Local) | !is.na(pm10_ref)) %>%
  dplyr::select(Date.Local, pm10_ref)

summary(no2_ref$no2_ref)
summary(pm25_ref$pm25_ref)
summary(pm10_ref$pm10_ref)


```
Summary values all make sense. The very high PM10 values all have description qualifiers on them in the raw data noting high wind events (eg dust storms), which are a known issue in this area that will push Pima County to violate PM10 NAAQS standards. Next step is to merge together by start date to relevant pollutant.

##### Create Daily Avg for PDEQ Background Monitors
```{r, echo=FALSE, message=FALSE, warning=FALSE}


```



#### TAPS Data
TAPS data is relatively easy to work with and this has already been pulled in with the script TAPS_Data_Cleaning. It does QC and does the annual averages just as ESCAPE did.

#### PCWS Data
PCWS data is collected over 5 years, so much messier. 


