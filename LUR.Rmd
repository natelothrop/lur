---
title: "Lothrop PhD - Aim 1"
author: "Nathan Lothrop"
date: "January 20, 2019"
output: html_document
---


## General LUR Workflow

In order to create the best externally validated LUR model for each pollutant, there are several steps: 

1. wrangling the source data for TAPS and PCWS, as well as PDEQ background monitor data; 
2. developing the LUR model using the ESCAPE method; and 
3. externally validating the model with 4 different ways of adjusting for changes over time.

### Wrangling Study Data

Basic steps:

1. Pull in study data
2. pull in background PDEQ monitor
3. create annual avg of each pollutant via ESCAPE method

However PCWS didn't follow ESCAPE so this is slightly more involved and we will have to make assumptions compared to TAPS.

```{r Data Setup, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# Clear environment of temporary files
rm(list=ls())

# Read in packages
packages <- c('Hmisc', 'corrplot', 'tidyverse', 'ggplot2', 'lubridate')


package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})

#read in all p5 data
p5all<- read.csv("/Users/nathanlothrop/Dropbox/P5_TAPS_TEMP/P5/Data/LUR/Results/P5_Master.csv")

#subset out the monitor data that has hhid >5000
monitor<-subset(p5all,hhid>5001)
data<-subset(p5all,hhid<5001)

str(data)

keeps<-c("hhid","stday","stmon","styear",
         "endday","endmon","endyear"
         ,"no2ppb", "pm25ugm3","pm10ugm3")
data<-data[keeps]

# Average duplicates (same run period)
data <- data %>%
  group_by(hhid,stday,stmon,styear,endday,endmon,endyear) %>%
  summarise(no2ppb = mean(no2ppb),
         pm25ugm3 = mean(pm25ugm3),
         pm10ugm3 = mean(pm10ugm3))

# Assign 1 of 3 season values (Winter, Intermed, Summer)
data$stssn3 <- ifelse((data$stmon==3 | data$stmon==4 | data$stmon==9 | data$stmon==10), 2,
                     ifelse((data$stmon==1 | data$stmon==2 | data$stmon==11 | data$stmon==12), 1, 3))
                               
data$stssn3 <- factor(data$stssn3,
                    levels = c(1,2,3),
                    labels = c("Winter", "Intermed.", "Summer"))

# Assign 1 of 4 season values (Winter, Spring, Summer, Fall)
data$stssn4 <- ifelse((data$stmon==1 | data$stmon==2 | data$stmon==11 | data$stmon==12), 1,
                      ifelse((data$stmon==3 | data$stmon==4), 2,
                              ifelse((data$stmon==5 | data$stmon==6 | data$stmon==7 | data$stmon==8), 3, 4)))
                               
data$stssn4 <- factor(data$stssn4,
                    levels = c(1,2,3,4),
                    labels = c("Winter", "Spring", "Summer", "Fall"))

datano2 <- subset(data,!is.na(no2ppb))
datapm25 <- subset(data,!is.na(pm25ugm3))
datapm10 <- subset(data,!is.na(pm10ugm3))
```

######PCWS NO2
```{r, echo=FALSE, warning=FALSE}

datano2 %>%
  group_by(styear) %>%
  summarise(n.obs=length(no2ppb),
            n.homes=n_distinct(hhid),
            geomean=exp(mean(log(no2ppb))),
            mean=mean(no2ppb),
            geosd=exp(sd(log(no2ppb))),
            min=min(no2ppb),
            max=max(no2ppb))


data %>%
  filter(!is.na(no2ppb)) %>%
  group_by(hhid) %>%
  summarise(n.obs=length(no2ppb),
            n.homes=n_distinct(hhid),
            geomean=exp(mean(log(no2ppb))),
            mean=mean(no2ppb),
            geosd=exp(sd(log(no2ppb))),
            min=min(no2ppb),
            max=max(no2ppb))
```

######PCWS PM2.5
```{r, echo=FALSE, warning=FALSE}

datapm25 %>%
  group_by(styear) %>%
  summarise(n.obs=length(pm25ugm3),
            n.homes=n_distinct(hhid),
            geomean=exp(mean(log(pm25ugm3))),
            mean=mean(pm25ugm3),
            geosd=exp(sd(log(pm25ugm3))),
            min=min(pm25ugm3),
            max=max(pm25ugm3))
```

######PCWS PM10
```{r, echo=FALSE, warning=FALSE}

datapm10 %>%
  group_by(styear) %>%
  summarise(n.obs=length(pm10ugm3),
            n.homes=n_distinct(hhid),
            geomean=exp(mean(log(pm10ugm3))),
            mean=mean(pm10ugm3),
            geosd=exp(sd(log(pm10ugm3))),
            min=min(pm10ugm3),
            max=max(pm10ugm3))

data %>%
  filter(!is.na(pm10ugm3)) %>%
  group_by(hhid) %>%
  summarise(n.obs=length(pm10ugm3),
            n.homes=n_distinct(hhid),
            geomean=exp(mean(log(pm10ugm3))),
            mean=mean(pm10ugm3),
            geosd=exp(sd(log(pm10ugm3))),
            min=min(pm10ugm3),
            max=max(pm10ugm3))

```
Many PCWS homes are measured more than once in a year, but often are measured back to back (one week, then the next). We will use all measures (and correct for changes in air pollution levels over time), as ESCAPE allows for 1-3 or more measures throughout the year (see page 9 and 10 here: http://escapeproject.eu/manuals/ESCAPE_Exposure-manualv9.pdf).

However, before committing to this, we will investigate how many homes have measures over multiple years, because if they do, then it may not make sense in LUR development if we have predictors that change over the time span to put all homes in the same model.


######Homes with more than 2 measures in different MONTHS in the same year for NO2:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

# data %>%
#   filter(!is.na(no2ppb)) %>%
#   dplyr::group_by(hhid,styear, stmon) %>%
#   summarise(n_homes = n_distinct(hhid),
#             n_obs_no2 = n_distinct(no2ppb)) %>%
#   arrange(desc(n_obs_no2, hhid))
data %>%
  filter(!is.na(no2ppb)) %>%
  dplyr::group_by(hhid,styear, stmon) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(no2ppb))

datano2 <- datano2 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(no2_bymonth = n_distinct(stmon))

datano2 %>%
  filter(no2_bymonth>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(no2ppb))
```
So for NO2, there are multiple homes in 87-89 with 2 or more measures in the same month and different months in the same year.


Let's check this same thing for PM2.5.

######Homes with 2 or more measures in different MONTHS in the same year for PM2.5:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm25 <- datapm25 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm25_bymonth = n_distinct(stmon))

datapm25 %>%
  filter(pm25_bymonth>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm25ugm3))
```
For PM2.5, only 2 homes have more than 1 measure in different months. 

######Homes with 2 or more measures in different MONTHS in the same year for PM10:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm10 <- datapm10 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm10_bymonth = n_distinct(stmon))

datapm10 %>%
  filter(pm10_bymonth>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm10ugm3))
```
For PM10, only 2 homes have more than 1 measure in different months. 


######Homes with 2 or more measures in different SEASONS in the same year (ESCAPE 3-season approach) for NO2:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datano2 <- datano2 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(no2_byseason3 = n_distinct(stssn3))

datano2 %>%
  filter(no2_byseason3>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(no2ppb))
``` 

######Homes with 2 or more measures in different SEASONS in the same year (ESCAPE 3-season approach) for PM2.5:
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# 
# data %>%
#   filter(!is.na(no2ppb)) %>%
#   dplyr::group_by(hhid,styear, stssn3) %>%
#   summarise(n_homes = n_distinct(hhid),
#             n_obs_no2 = n_distinct(no2ppb)) %>%
#   arrange(desc(n_obs_no2, hhid))

datapm25 <- datapm25 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm25_byseason3 = n_distinct(stssn3))

datapm25 %>%
  filter(pm25_byseason3>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm25ugm3))
``` 
There are NO homes with 2 or more PM2.5 measures in different ESCAPE seasons in same year.

######Homes with 2 or more measures in different SEASONS in the same year (ESCAPE 3-season approach) for PM10:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm10 <- datapm10 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm10_byseason3 = n_distinct(stssn3))

datapm10 %>%
  filter(pm10_byseason3>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm10ugm3))
``` 
There are NO homes with 2 or more PM10 measures in different ESCAPE seasons in same year.

######Homes with 2 or more measures in different SEASONS in the same year (non-ESCAPE 4-season approach) for NO2:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datano2 <- datano2 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(no2_byseason4 = n_distinct(stssn4))

datano2 %>%
  filter(no2_byseason4>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(no2ppb))
``` 
######Homes with 2 or more measures in different SEASONS in the same year (non-ESCAPE 4-season approach) for PM2.5:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm25 <- datapm25 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm25_byseason4 = n_distinct(stssn4))

datapm25 %>%
  filter(pm25_byseason4>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm25ugm3))
```
No homes again for PM2.5, using 4 season approach.

######Homes with 2 or more measures in different SEASONS in the same year (non-ESCAPE 4-season approach) for PM10:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm10 <- datapm10 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm10_byseason4 = n_distinct(stssn4))

datapm10 %>%
  filter(pm10_byseason4>1) %>%
  group_by(styear) %>%
  summarise(n_homes = n_distinct(hhid),
            n_obs = n_distinct(pm10ugm3))
```
No homes again for PM10, using 4 season approach.

Since only NO2 has >1 measure/season or month in more than a handful of homes like PM2.5 and PM10, we'll base our season definition off this. 

**We'll go with the 3 season as this the ESCAPE approach** which we want to follow anyways and there are no difference b/w 3 and 4 month season definitions.

Now let's look at whether there are homes that have >1 NO2 measure in distinct months/year IN multiple years and the same, but for seasons in multiple years.

######Homes with 2 or more measures in different MONTHS in the same year over MULTIPLE years for NO2:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

#create frequency of measurement by year and season
#no2
datano2 <- datano2 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(no2_bymonth = n_distinct(stmon))

datano2 %>%
  group_by(hhid,styear) %>%
  summarise(n_obs_no2 = n_distinct(no2ppb)) %>%
  filter(n_obs_no2>1) %>%
  arrange(hhid,desc(n_obs_no2))
```

There are many homes that have obs in more than 1 year (>1 distinct measure/month).


######Homes with 2 or more measures in different SEASONS in the same year over MULTIPLE years for NO2:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

#create frequency of measurement by year and season
#no2
datano2 <- datano2 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(no2_byseason3 = n_distinct(stssn3))

datano2 %>%
  filter(no2_byseason3>1) %>%
  group_by(hhid) %>%
  summarise(n_years = n_distinct(styear),
            n_obs = n_distinct(no2ppb)) %>%
  arrange(desc(n_years,hhid))

datano2 %>%
  group_by(hhid) %>%
  summarise(n_unique_years = n_distinct(styear),
            n_obs = n_distinct(no2ppb)) %>%
  filter(n_unique_years>2) %>%
  arrange(desc(n_unique_years,n_obs))
```
**NO2**
Of 334 homes, 155 have measures in 2 different years, amd 15 have measures in 3 different years.

######PM2.5 test for how many homes have measures in multiple seasons and multiple years:
```{r, echo=FALSE, message=FALSE, warning=FALSE}

datapm25 <- datapm25 %>%
  dplyr::group_by(hhid,styear) %>%
  mutate(pm25_byseason3 = n_distinct(stssn3))

datapm25 %>%
  filter(pm25_byseason3>1) %>%
  group_by(hhid) %>%
  summarise(n_years = n_distinct(styear),
            n_obs = n_distinct(pm25ugm3)) %>%
  arrange(desc(n_years,hhid))

datapm25 %>%
  group_by(hhid) %>%
  summarise(n_unique_years = n_distinct(styear),
            n_obs = n_distinct(pm25ugm3)) %>%
  # filter(n_unique_years>1) %>%
  arrange(desc(n_unique_years,n_obs))
```

**PM2.5**
Of 60 homes, 7 have measures in different years. The rest have only a single measure (in a single year).

**After speaking with Dr. Beamer on 1/30/19 in office hours, the approach will be this:**

1. for a single pollutant (NO2?) do annual average for all homes, regardless of how many times they're measured
2. complete LUR model for this "all homes" approach (all homes get year-specific predictor, eg a home with 1987 avg will have the traffic volume predictors be named same as home from 1989, but have year-specific value)
3. then, as a sensitivity analysis, do it so that each home is included annual average just once in model

#### PCWS Annual Averages

##### Create Daily Avg for PDEQ Background Monitors
```{r, echo=FALSE, message=FALSE, warning=FALSE}

# Read in NO2, PM2.5, and PM10 background values from the longest, constantly running PDEQ monitors for NAAQS compliance
# Downloaded in 20 year increments for all available data from 1980 - 2017 from https://aqs.epa.gov/api on 2018/12/28 with user: lothrop@email.arizona.edu and password 'rubycat56'
# NO2, PM2.5, and PM10 monitor sites that running longest aren't same (NO2: Alvernon/Craycroft; PM2.5: Saguaro Park; PM10: Orange Grove)
# Note that PM2.5 monitoring is taken offline temporarily at Saguaro Park 1994-1999

wd <- "/Users/nathanlothrop/Dropbox/P5_TAPS_TEMP/Data/PDEQHistoric"

no2_ref <- read.csv(paste0(wd,"/","NO2_1980_2000.txt"), header = T)

pm25_ref <- read.csv(paste0(wd,"/","PM25_1980_2000.txt"), header = T)

pm10_ref <- read.csv(paste0(wd,"/","PM10_1980_2000.txt"), header = T)

# Create annual averages for each pollutant type
no2_ref <- no2_ref %>%
  dplyr::group_by(Date.Local) %>%
  dplyr::summarise(no2_ref = mean(Sample.Measurement)) %>%
  dplyr::filter(!is.na(Date.Local) | !is.na(no2_ref)) %>%
  dplyr::select(Date.Local, no2_ref)

pm25_ref <- pm25_ref %>%
  dplyr::group_by(Date.Local) %>%
  dplyr::summarise(pm25_ref = mean(Sample.Measurement)) %>%
  dplyr::filter(!is.na(Date.Local) | !is.na(pm25_ref)) %>%
  dplyr::select(Date.Local, pm25_ref)
  
pm10_ref <- pm10_ref %>%
  dplyr::group_by(Date.Local) %>%
  dplyr::summarise(pm10_ref = mean(Sample.Measurement)) %>%
  dplyr::filter(!is.na(Date.Local) | !is.na(pm10_ref)) %>%
  dplyr::select(Date.Local, pm10_ref)

no2_ref <- filter(no2_ref, !is.na(no2_ref))
pm25_ref <- filter(pm25_ref, !is.na(pm25_ref))
pm10_ref <- filter(pm10_ref, !is.na(pm10_ref))

summary(no2_ref$no2_ref)
summary(pm25_ref$pm25_ref)
summary(pm10_ref$pm10_ref)


```
Summary values all make sense. The very high PM10 values all have description qualifiers on them in the raw data noting high wind events (eg dust storms), which are a known issue in this area that will push Pima County to violate PM10 NAAQS standards. Next step is to merge together by start date to relevant pollutant.

```{r, echo=FALSE, message=FALSE, warning=FALSE}

#read in all p5 data
p5all<- read.csv("/Users/nathanlothrop/Dropbox/P5_TAPS_TEMP/P5/Data/LUR/Results/P5_Master.csv")

#subset out the monitor data that has hhid >5000
monitor<-subset(p5all,hhid>5001)
data<-subset(p5all,hhid<5001)

str(data)

keeps<-c("hhid","stday","stmon","styear",
         "endday","endmon","endyear"
         ,"no2ppb", "pm25ugm3","pm10ugm3")
data<-data[keeps]

# Average duplicates (same run period)
data <- data %>%
  group_by(hhid,stday,stmon,styear,endday,endmon,endyear) %>%
  summarise(no2ppb = mean(no2ppb),
         pm25ugm3 = mean(pm25ugm3),
         pm10ugm3 = mean(pm10ugm3))


# Assign 1 of 3 season values (Winter, Intermed, Summer)
data$stssn3 <- ifelse((data$stmon==3 | data$stmon==4 | data$stmon==9 | data$stmon==10), 2,
                     ifelse((data$stmon==1 | data$stmon==2 | data$stmon==11 | data$stmon==12), 1, 3))
                               
data$stssn3 <- factor(data$stssn3,
                    levels = c(1,2,3),
                    labels = c("Winter", "Intermed.", "Summer"))

# Assign 1 of 4 season values (Winter, Spring, Summer, Fall)
data$stssn4 <- ifelse((data$stmon==1 | data$stmon==2 | data$stmon==11 | data$stmon==12), 1,
                      ifelse((data$stmon==3 | data$stmon==4), 2,
                              ifelse((data$stmon==5 | data$stmon==6 | data$stmon==7 | data$stmon==8), 3, 4)))
                               
data$stssn4 <- factor(data$stssn4,
                    levels = c(1,2,3,4),
                    labels = c("Winter", "Spring", "Summer", "Fall"))

datano2 <- subset(data,!is.na(no2ppb))
datapm25 <- subset(data,!is.na(pm25ugm3))
datapm10 <- subset(data,!is.na(pm10ugm3))


```

##### Create annual averages corrected for temporal changes
```{r, echo=FALSE, message=FALSE, warning=FALSE}

# Approach:
# 1. figure out what ref monitor dates are after the start date and before the end date of the home measurement (through decimalized dating)
# 2. for this ref date period, take the average of the pollutant measurement, then divide that by the annual average to get the ratio temporal correction
# 3. multiple the ratio temporal correction by the home measure for that period
# 4. average the product(s) from step 3, resulting in the home's annual average

# Create decimalized dates for ref data
no2_ref$date_dec <- decimal_date(as.Date(no2_ref$Date.Local,format="%Y-%m-%d"))
pm25_ref$date_dec <- decimal_date(as.Date(pm25_ref$Date.Local,format="%Y-%m-%d"))
pm10_ref$date_dec <- decimal_date(as.Date(pm10_ref$Date.Local,format="%Y-%m-%d"))

# Create monthly and annual averages for ref data-NO2
no2_ref$year <- as.integer(year(no2_ref$Date.Local))
no2_ref$mon <- as.integer(month(no2_ref$Date.Local))

no2_ref_yearavg <- no2_ref %>%
  group_by(year) %>%
  summarise(no2_year_avg=mean(no2_ref))

no2_ref_monavg <- no2_ref %>%
  group_by(mon, year) %>%
  summarise(no2_mon_avg=mean(no2_ref))

# Create monthly and annual averages for ref data-PM2.5
pm25_ref$year <- as.integer(year(pm25_ref$Date.Local))
pm25_ref$mon <- as.integer(month(pm25_ref$Date.Local))

pm25_ref_yearavg <- pm25_ref %>%
  group_by(year) %>%
  summarise(pm25_year_avg=mean(pm25_ref))

pm25_ref_monavg <- pm25_ref %>%
  group_by(mon, year) %>%
  summarise(pm25_mon_avg=mean(pm25_ref))

# Create monthly and annual averages for ref data-PM10
pm10_ref$year <- as.integer(year(pm10_ref$Date.Local))
pm10_ref$mon <- as.integer(month(pm10_ref$Date.Local))

pm10_ref_yearavg <- pm10_ref %>%
  group_by(year) %>%
  summarise(pm10_year_avg=mean(pm10_ref))

pm10_ref_monavg <- pm10_ref %>%
  group_by(mon, year) %>%
  summarise(pm10_mon_avg=mean(pm10_ref))

# Create decimalized dates (start and end) for measurement data
data$styear <- data$styear + 1900
data$endyear <- data$endyear + 1900

data$st_date <- as.Date(with(data, paste(styear, stmon, stday,sep="-")), "%Y-%m-%d")
data$end_date <- as.Date(with(data, paste(endyear, endmon, endday,sep="-")), "%Y-%m-%d")

data$stdate_dec <- decimal_date(as.Date(data$st_date,format="%Y-%m-%d"))
data$enddate_dec <- decimal_date(as.Date(data$end_date,format="%Y-%m-%d"))

# Join monthly and yearly averages of reference monitors to measurement data
data <- full_join(data,no2_ref_monavg,by=c("styear"="year","stmon"="mon"))
data <- full_join(data,no2_ref_yearavg,by=c("styear"="year"))
data <- full_join(data,pm25_ref_monavg,by=c("styear"="year","stmon"="mon"))
data <- full_join(data,pm25_ref_yearavg,by=c("styear"="year"))
data <- full_join(data,pm10_ref_monavg,by=c("styear"="year","stmon"="mon"))
data <- full_join(data,pm10_ref_yearavg,by=c("styear"="year"))

# Filter out those that have no hhid
data <- filter(data, !is.na(hhid))

# Create the ratio-adjusted NO2 measurement (no2_adj)
data$no2_adj <- 0
for(i in 1:nrow(data)){
  stdate <- c(data[i,15])
  enddate <- c(data[i,16])
  no2_period_avg <- mean(as.numeric(unlist(c(no2_ref[no2_ref$date_dec >= stdate & no2_ref$date_dec <= enddate,2])))) # calculate the average ref for that period of measurment
  if(!is.na(no2_period_avg)){ # Note!-not all measurement periods have a ref monitor running, so use the monthly average (of that starting measurement month) to annual ratio instead
    no2_period_ratio <- no2_period_avg/data[i,18] # calculate the ratio of ref period to annual avg
    data[i,23] <- no2_period_ratio * data[i,8] # adjust measurement by period to year ratio
  }else{
    no2_mon_ratio <- data[i,17]/data[i,18] # calculate the ratio of ref mon to annual avg
    data[i,23] <- no2_mon_ratio * data[i,8] # adjust measurement by month to year ratio
    }
}

# Look for NO2 measures that have a raw measurement but no temporally-adjusted concentration
sum(!is.na(data$no2ppb) & is.na(data$no2_adj))

# Create the ratio-adjusted PM2.5 measurement (pm25_adj)
data$pm25_adj <- 0
for(i in 1:nrow(data)){
  stdate <- c(data[i,15])
  enddate <- c(data[i,16])
  pm25_period_avg <- mean(as.numeric(unlist(c(pm25_ref[pm25_ref$date_dec >= stdate & pm25_ref$date_dec <= enddate,2])))) # calculate the average ref for that period of measurment
  if(!is.na(pm25_period_avg)){ # Note!-not all measurement periods have a ref monitor running, so use the monthly average (of that starting measurement month) to annual ratio instead
    pm25_period_ratio <- pm25_period_avg/data[i,20] # calculate the ratio of ref period to annual avg
    data[i,24] <- pm25_period_ratio * data[i,9] # adjust measurement by period to year ratio
  }else{
    pm25_mon_ratio <- data[i,19]/data[i,20] # calculate the ratio of ref mon to annual avg
    data[i,24] <- pm25_mon_ratio * data[i,9] # adjust measurement by month to year ratio
    }
}

# Look for PM2.5 measures that have a raw measurement but no temporally-adjusted concentration
sum(!is.na(data$pm25ugm3) & is.na(data$pm25_adj))

# Create the ratio-adjusted PM10 measurement (pm10_adj)
data$pm10_adj <- 0
for(i in 1:nrow(data)){
  stdate <- c(data[i,15])
  enddate <- c(data[i,16])
  pm10_period_avg <- mean(as.numeric(unlist(c(pm10_ref[pm10_ref$date_dec >= stdate & pm10_ref$date_dec <= enddate,2])))) # calculate the average ref for that period of measurment
  if(!is.na(pm10_period_avg)){ # Note!-not all measurement periods have a ref monitor running, so use the monthly average (of that starting measurement month) to annual ratio instead
    pm10_period_ratio <- pm10_period_avg/data[i,22] # calculate the ratio of ref period to annual avg
    data[i,25] <- pm10_period_ratio * data[i,10] # adjust measurement by period to year ratio
  }else{
    pm10_mon_ratio <- data[i,21]/data[i,22] # calculate the ratio of ref mon to annual avg
    data[i,25] <- pm10_mon_ratio * data[i,10] # adjust measurement by month to year ratio
    }
}

# Look for PM10 measures that have a raw measurement but no temporally-adjusted concentration
sum(!is.na(data$pm10ugm3) & is.na(data$pm10_adj))


```
PM2.5 measures in PCWS started in March 1987, but reference background monitoring didn't start until June 1988. This leaves `r sum(!is.na(data$pm25ugm3) & is.na(data$pm25_adj))` homes without reference values to temporally correct. To correct, we will test to see if we can use the monthly ratio of the closest reference dates from a full monitoring year to fill in March 1987-May 1988 (eg using all of 1989).

``` {r}

pm25_ref_replaceavg <- full_join(pm25_ref_monavg,pm25_ref_yearavg,by=c("year"))
pm25_ref_replaceavg$ratio <- 0
pm25_ref_replaceavg$ratio <- pm25_ref_replaceavg$pm25_mon_avg/pm25_ref_replaceavg$pm25_year_avg

pm25_ref_replaceavg_88 <- pm25_ref_replaceavg %>%
  filter(year==1988)
pm25_ref_replaceavg_89 <- pm25_ref_replaceavg %>%
  filter(year==1989)
pm25_ref_replaceavg_90 <- pm25_ref_replaceavg %>%
  filter(year==1990)
pm25_ref_replaceavg_91 <- pm25_ref_replaceavg %>%
  filter(year==1991)
pm25_ref_replaceavg_92 <- pm25_ref_replaceavg %>%
  filter(year==1992)

pm25_ref_replaceavg_ratios <- full_join(pm25_ref_replaceavg_89,pm25_ref_replaceavg_90,by=c("mon"))
pm25_ref_replaceavg_ratios <- full_join(pm25_ref_replaceavg_ratios,pm25_ref_replaceavg_91,by=c("mon"))
pm25_ref_replaceavg_ratios <- full_join(pm25_ref_replaceavg_ratios,pm25_ref_replaceavg_92,by=c("mon"))

```

The pearson correlations of month to month ratios for years of 89 to 90, 90 to 91, and 91 to 92 are `r cor(pm25_ref_replaceavg_ratios$ratio.x, pm25_ref_replaceavg_ratios$ratio.y, method="pearson")`, `r cor(pm25_ref_replaceavg_ratios$ratio.y, pm25_ref_replaceavg_ratios$ratio.x.x, method="pearson")`
, and `r cor(pm25_ref_replaceavg_ratios$ratio.x.x, pm25_ref_replaceavg_ratios$ratio.y.y, method="pearson")`, respectively.

This shows that month to year variation between years is wide!

To fill in the unknown monthly ratios for PM2.5 from March 1987 - May 1988, we'll use the 1989 ratios for now. We can ask this question in lab meeting...

```{r}



```



<<<<<<< HEAD

=======
>>>>>>> 484f471aac259fcfc065e6973f2e4bb01b62c6e2
Ditto for season!

Now we know that PCWS homes that have >1 measure/year (an ESCAPE inclusion criteria) only have this multiple measures over a single year. This means we can move forward with the outlined idea discussed with group at the Beamer lab meeting on 1/16/19:

1. do annual average only for all homes with >1 measure in 1987, then for all homes with measures in 1988...1992
2. run GIS predictor development to get year-specific predictors for each yearly dataset, each predictor name should be IDENTICAL
3. append all these datasets (stack rows)
4. build LUR for each pollutant
5. using annual average data, externally validate TAPS model

#### PCWS-Create annual avg for homes with 

#### TAPS Data
TAPS data is relatively easy to work with and this has already been pulled in with the script TAPS_Data_Cleaning. It does QC and does the annual averages just as ESCAPE did.

#### PCWS Data
PCWS data is collected over 5 years, so much messier. 


